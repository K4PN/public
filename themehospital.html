<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Galer√≠a m√≥vil (edici√≥n EXIF en carpeta)</title>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Galer√≠a EXIF&quot;,&quot;short_name&quot;:&quot;Galer√≠a EXIF&quot;,&quot;display&quot;:&quot;standalone&quot;}">
<meta name="theme-color" content="#0f172a">
<script src="https://unpkg.com/exifr/dist/full.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.js"></script>
<style>
  :root{
    --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --text:#e5e7eb; --acc:#22d3ee; --acc2:#38bdf8; --bd:#1f2937;
    --tap: 14px; /* √°rea m√≠nima t√°ctil extra */
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{margin:0; padding:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(15,23,42,.85); backdrop-filter: blur(10px);
    border-bottom:1px solid var(--bd);
  }
  .wrap{max-width:820px; margin:0 auto; padding:12px}
  h1{font-size:1.05rem; margin:0 0 8px; font-weight:700; letter-spacing:.2px}
  .bar{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center}
  .search{
    display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--bd);
    border-radius:14px; padding:10px 12px;
  }
  .search input{flex:1; background:transparent; border:0; outline:0; color:var(--text); font-size:16px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    min-height:44px; padding:10px 14px; border-radius:999px; font-weight:800; border:0; cursor:pointer;
    background:linear-gradient(135deg,var(--acc),var(--acc2)); color:#002033;
  }
  .btn.secondary{background:#0b1220; color:var(--text); border:1px solid var(--bd)}
  .hint{color:var(--muted); font-size:.9rem; margin-top:6px}
  main{padding:8px 0 80px}
  .grid{
    display:grid; gap:8px;
    grid-template-columns: repeat(2,1fr);
  }
  @media (min-width:480px){ .grid{ grid-template-columns: repeat(3,1fr);} }
  .card{background:var(--card); border:1px solid var(--bd); border-radius:12px; overflow:hidden}
  .thumb{display:block; width:100%; aspect-ratio:1/1; object-fit:cover; background:#08101c}
  .metaRow{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 10px}
  .metaRow small{color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:75%}

  /* Barra fija inferior con acciones r√°pidas (m√≥vil) */
  .dock{
    position:fixed; bottom:0; left:0; right:0; z-index:20;
    display:flex; gap:8px; padding:10px; background:rgba(8,16,28,.85); border-top:1px solid var(--bd);
    backdrop-filter: blur(10px);
  }
  .dock .btn{flex:1}

  /* Visor */
  dialog#viewer{
    inset:0; margin:auto; width:100%; max-width:900px; height:100svh; max-height:100svh;
    border:0; padding:0; background:var(--bg); color:var(--text);
  }
  .viewer-head{
    position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:12px; background:rgba(15,23,42,.9); border-bottom:1px solid var(--bd); backdrop-filter: blur(8px);
  }
  .viewer-head h2{font-size:1rem; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:70%}
  .close{background:#0b1220; color:var(--text); border:1px solid var(--bd); border-radius:12px; padding:8px 12px; font-size:1rem}
  .viewer-body{display:grid; grid-template-rows: auto 1fr auto; height:calc(100svh - env(safe-area-inset-bottom));}
  .viewer-img{
    display:flex; align-items:center; justify-content:center; background:#0b1220; border-bottom:1px solid var(--bd);
    min-height:40vh; max-height:55vh; overflow:hidden;
  }
  .viewer-img img{max-width:100%; max-height:55vh}
  .viewer-form{padding:12px; overflow:auto}
  form .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  form .row.full{grid-template-columns: 1fr}
  form label{font-size:.85rem; color:var(--muted); display:block; margin-top:8px}
  form input, form textarea{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--bd); background:#0b1220; color:var(--text);
    font-size:16px; /* evita zoom iOS */
  }
  form textarea{min-height:80px; resize:vertical}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
  .actions .btn{flex:1; min-width:46%}
  .note{color:var(--muted); font-size:.9rem; margin-top:8px}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üìÇ Galer√≠a m√≥vil (editar EXIF en carpeta)</h1>
      <div class="bar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.3-4.3m1.3-5.4A7.6 7.6 0 1 1 10.4 3a7.6 7.6 0 0 1 7.6 7.6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" type="text" placeholder="Buscar por nombre, t√≠tulo, autor, palabras clave‚Ä¶">
        </div>
        <button id="btnPick" class="btn">Elegir carpeta</button>
      </div>
      <div id="supportNote" class="hint"></div>
    </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid"></div>
  </main>

  <!-- Dock inferior (m√≥vil) -->
  <div class="dock">
    <button id="btnRecheck" class="btn secondary">Revisar permiso</button>
    <button id="btnRefresh" class="btn secondary">Recargar carpeta</button>
  </div>

  <!-- Visor / Editor -->
  <dialog id="viewer">
    <div class="viewer-body">
      <div class="viewer-head">
        <h2 id="fname">‚Äî</h2>
        <button class="close" id="close">Cerrar</button>
      </div>
      <div class="viewer-img">
        <img id="big" alt="preview">
      </div>
      <div class="viewer-form">
        <form id="metaForm" autocomplete="off">
          <div class="row full">
            <label>Nombre de archivo
              <input id="f_name" type="text" readonly>
            </label>
          </div>
          <div class="row">
            <label>T√≠tulo (XPTitle/XMP)
              <input id="f_title" type="text" inputmode="text" placeholder="Atardecer‚Ä¶">
            </label>
            <label>Autor (Artist)
              <input id="f_artist" type="text" inputmode="text" placeholder="Tu nombre">
            </label>
          </div>
          <div class="row">
            <label>Palabras clave (; separadas)
              <input id="f_keywords" type="text" inputmode="text" placeholder="playa; verano; viaje">
            </label>
            <label>Derechos (Copyright)
              <input id="f_copyright" type="text" inputmode="text" placeholder="¬© 2025 Carlos">
            </label>
          </div>
          <div class="row full">
            <label>Descripci√≥n
              <textarea id="f_desc" placeholder="Contexto‚Ä¶"></textarea>
            </label>
          </div>
          <div class="row">
            <label>Fecha de captura
              <input id="f_datetime" type="datetime-local">
            </label>
            <label>GPS (lat, lon)
              <input id="f_gps" type="text" inputmode="decimal" placeholder="40.4168, -3.7038">
            </label>
          </div>
          <div class="actions">
            <button type="button" class="btn" id="btnWriteInPlace">üíæ Guardar en este archivo (JPG)</button>
            <button type="button" class="btn secondary" id="btnDownloadCopy">‚¨áÔ∏è Descargar copia con EXIF</button>
          </div>
          <div id="formatNote" class="note"></div>
        </form>
      </div>
    </div>
  </dialog>

<script>
const $ = s => document.querySelector(s);
const state = {
  dirHandle: null,
  writeGranted: false,
  entries: [],  // {handle, file, url, name, type, meta}
  filtered: [],
  currentIdx: -1,
};

/* --- Compatibilidad y ayuda --- */
function updateSupportNote(){
  const ok = 'showDirectoryPicker' in window;
  $("#supportNote").textContent = ok
    ? "Consejo: en Android/Chrome podr√°s elegir una carpeta (p.ej. Pictures/MisFotos) y guardar EXIF dentro del JPG."
    : "Tu navegador no soporta acceso de carpeta. Podr√°s descargar copias con EXIF.";
}
updateSupportNote();

/* --- UI eventos --- */
$("#btnPick").addEventListener("click", pickFolder);
$("#btnRecheck").addEventListener("click", checkPermission);
$("#btnRefresh").addEventListener("click", async ()=>{
  if (state.dirHandle) await loadImagesFromDir(state.dirHandle);
});
$("#q").addEventListener("input", applyFilter);
$("#close").addEventListener("click", ()=> $("#viewer").close());
document.addEventListener("keydown",(e)=>{ if (e.key==="Escape" && $("#viewer").open) $("#viewer").close(); });

/* --- Elegir carpeta y permisos --- */
async function pickFolder(){
  if (!('showDirectoryPicker' in window)){
    alert("Navegador sin acceso a carpetas. Usa la descarga de copia.");
    return;
  }
  try{
    const dir = await showDirectoryPicker({ mode:'readwrite' });
    state.dirHandle = dir;
    await checkPermission();
    await loadImagesFromDir(dir);
  }catch(e){
    if (e?.name !== 'AbortError') console.error(e);
  }
}
async function checkPermission(){
  if (!state.dirHandle){ alert("Elige primero una carpeta."); return; }
  const opt = { mode:'readwrite' };
  let p = await state.dirHandle.queryPermission(opt);
  if (p !== 'granted') p = await state.dirHandle.requestPermission(opt);
  state.writeGranted = (p === 'granted');
  alert(state.writeGranted ? "Permiso de escritura concedido." : "Sin permiso de escritura. Solo lectura/descarga.");
}

/* --- Carga de im√°genes de la carpeta --- */
async function loadImagesFromDir(dirHandle){
  state.entries = [];
  for await (const [name, handle] of dirHandle.entries()){
    if (handle.kind !== 'file') continue;
    if (!/\.(jpe?g|png|webp|heic|heif)$/i.test(name)) continue;
    const file = await handle.getFile();
    const url  = URL.createObjectURL(file);
    const meta = await readMeta(file);
    state.entries.push({ handle, file, url, name, type: file.type || guessType(name), meta });
  }
  state.filtered = state.entries.sort((a,b)=> a.name.localeCompare(b.name));
  renderGrid();
}
function guessType(name){
  const ext = (name.split('.').pop()||'').toLowerCase();
  return ({jpg:'image/jpeg',jpeg:'image/jpeg',png:'image/png',webp:'image/webp',heic:'image/heic',heif:'image/heif'})[ext] || 'image/*';
}

/* --- Lectura de metadatos --- */
async function readMeta(file){
  try{
    const data = await exifr.parse(file, { xmp:true, iptc:true });
    const title = data?.XPTitle || data?.ImageDescription || getXmpTitle(data?.xmp) || "";
    const artist = data?.Artist || getXmpCreator(data?.xmp) || "";
    const keywords = getKeywords(data);
    const date = data?.DateTimeOriginal || data?.CreateDate || data?.ModifyDate || null;
    const gps = (typeof data?.latitude==="number" && typeof data?.longitude==="number") ? [data.latitude, data.longitude] : null;
    const desc = data?.ImageDescription || getXmpDescription(data?.xmp) || "";
    const copyright = data?.Copyright || "";
    return { title, artist, keywords, date, gps, desc, copyright };
  }catch{
    return { title:"", artist:"", keywords:[], date:null, gps:null, desc:"", copyright:"" };
  }
}
function getXmpTitle(xmp){ try{ const t=xmp?.["dc:title"]; return typeof t==="string"?t:(t?.["x-default"]||null);}catch{return null} }
function getXmpCreator(xmp){ try{ const c=xmp?.["dc:creator"]; return Array.isArray(c)&&c[0]?c[0]:null;}catch{return null} }
function getXmpDescription(xmp){ try{ const d=xmp?.["dc:description"]; return typeof d==="string"?d:(d?.["x-default"]||null);}catch{return null} }
function getKeywords(data){
  const s=new Set();
  if (data?.XPKeywords){ xpDecode(data.XPKeywords).split(";").map(t=>t.trim()).filter(Boolean).forEach(v=>s.add(v)); }
  if (data?.iptc?.keywords){ data.iptc.keywords.forEach(v=>s.add(v)); }
  const subj = data?.xmp?.["dc:subject"]; if (subj){ (Array.isArray(subj)?subj:[subj]).forEach(v=>v&&s.add(String(v))); }
  return [...s];
}
function xpDecode(arr){
  try{
    const bytes=new Uint8Array(arr); let s="";
    for(let i=0;i<bytes.length;i+=2){ const code=bytes[i]|(bytes[i+1]<<8); if(code===0)break; s+=String.fromCharCode(code); }
    return s;
  }catch{ return Array.isArray(arr)?arr.join(""):String(arr||"") }
}
function xpEncode(str){
  const out=[]; for(const ch of str){ const c=ch.charCodeAt(0); out.push(c&0xff,c>>8); } out.push(0,0); return out;
}

/* --- Render rejilla --- */
function renderGrid(){
  const g = $("#grid"); g.innerHTML="";
  if (!state.filtered.length){ g.innerHTML=`<div class="hint">No hay im√°genes en la carpeta.</div>`; return; }
  for (let i=0;i<state.filtered.length;i++){
    const it = state.filtered[i];
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `
      <img class="thumb" loading="lazy" src="${it.url}" alt="${it.name}">
      <div class="metaRow">
        <small title="${it.name}">${it.name}</small>
        <small>${it.meta.title? "üìù":""} ${it.meta.gps? "üìç":""}</small>
      </div>`;
    card.addEventListener("click", ()=> openViewer(i));
    g.appendChild(card);
  }
}
function applyFilter(){
  const q = $("#q").value.trim().toLowerCase();
  state.filtered = state.entries.filter(it=>{
    const m = it.meta;
    return [
      it.name, m.title||"", m.artist||"", m.desc||"", (m.keywords||[]).join("; "), m.copyright||""
    ].join(" ").toLowerCase().includes(q);
  });
  renderGrid();
}

/* --- Visor y edici√≥n --- */
function openViewer(idx){
  state.currentIdx = idx;
  const it = state.filtered[idx];
  $("#big").src = it.url;
  $("#fname").textContent = it.name;
  $("#f_name").value = it.name;
  $("#f_title").value = it.meta.title || "";
  $("#f_artist").value = it.meta.artist || "";
  $("#f_keywords").value = (it.meta.keywords||[]).join("; ");
  $("#f_copyright").value = it.meta.copyright || "";
  $("#f_desc").value = it.meta.desc || "";
  $("#f_datetime").value = it.meta.date ? toLocalInput(it.meta.date) : "";
  $("#f_gps").value = it.meta.gps ? `${it.meta.gps[0].toFixed(6)}, ${it.meta.gps[1].toFixed(6)}` : "";

  const isJpg = /jpe?g$/i.test(it.name) || it.type==="image/jpeg";
  $("#btnWriteInPlace").disabled = !(isJpg && state.writeGranted);
  $("#formatNote").textContent = isJpg
    ? (state.writeGranted ? "JPEG: podr√°s escribir EXIF dentro del archivo." : "JPEG: sin permiso de escritura. Usa 'Descargar copia'.")
    : "No JPG: no se puede incrustar EXIF en el mismo archivo. Usa 'Descargar copia' para generar un JPG con EXIF.";
  $("#viewer").showModal();
}
function toLocalInput(d){
  const dt = new Date(d); const p=n=>String(n).padStart(2,"0");
  return `${dt.getFullYear()}-${p(dt.getMonth()+1)}-${p(dt.getDate())}T${p(dt.getHours())}:${p(dt.getMinutes())}`;
}
function readForm(){
  const gps = $("#f_gps").value.trim();
  let gpsArr = null;
  if (gps){
    const parts = gps.split(",").map(x=>parseFloat(x.trim()));
    if (parts.length===2 && parts.every(Number.isFinite)) gpsArr = parts;
  }
  return {
    title: $("#f_title").value.trim(),
    artist: $("#f_artist").value.trim(),
    keywords: $("#f_keywords").value.trim() ? $("#f_keywords").value.split(";").map(s=>s.trim()).filter(Boolean) : [],
    copyright: $("#f_copyright").value.trim(),
    desc: $("#f_desc").value.trim(),
    date: $("#f_datetime").value ? new Date($("#f_datetime").value).toISOString() : null,
    gps: gpsArr
  };
}

/* --- Guardar dentro del JPG (si es posible) --- */
$("#btnWriteInPlace").addEventListener("click", writeInPlace);
$("#btnDownloadCopy").addEventListener("click", downloadCopy);

function toExifDate(iso){
  const d=new Date(iso); const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}:${p(d.getMonth()+1)}:${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}
function toRational(num){ const den=1000000; return [Math.round(num*den),den]; }
function dmsRational(deg){
  const d=Math.floor(Math.abs(deg));
  const minF=(Math.abs(deg)-d)*60; const m=Math.floor(minF); const s=(minF-m)*60;
  return [[d,1],[m,1],toRational(s)];
}
async function buildJpegWithExif(fileOrBlob, meta){
  const dataURL = await fileToDataURL(fileOrBlob);
  const zeroth={}, exif={}, gps={};
  if (meta.title)     zeroth[piexif.ImageIFD.XPTitle] = xpEncode(meta.title);
  if (meta.desc)      zeroth[piexif.ImageIFD.ImageDescription] = meta.desc;
  if (meta.artist)    zeroth[piexif.ImageIFD.Artist] = meta.artist;
  if (meta.copyright) zeroth[piexif.ImageIFD.Copyright] = meta.copyright;
  if (meta.keywords?.length) zeroth[piexif.ImageIFD.XPKeywords] = xpEncode(meta.keywords.join("; "));
  if (meta.date){
    const dt=toExifDate(meta.date);
    exif[piexif.ExifIFD.DateTimeOriginal]=dt;
    zeroth[piexif.ImageIFD.DateTime]=dt;
  }
  if (meta.gps){
    const [lat,lon]=meta.gps;
    gps[piexif.GPSIFD.GPSLatitudeRef]  = lat>=0?"N":"S";
    gps[piexif.GPSIFD.GPSLatitude]     = dmsRational(lat);
    gps[piexif.GPSIFD.GPSLongitudeRef] = lon>=0?"E":"W";
    gps[piexif.GPSIFD.GPSLongitude]    = dmsRational(lon);
  }
  const exifBytes = piexif.dump({ "0th":zeroth, Exif:exif, GPS:gps });
  const newDataUrl = piexif.insert(exifBytes, dataURL);
  // DataURL -> Blob
  const bin = atob(newDataUrl.split(",")[1]);
  const buf = new Uint8Array(bin.length);
  for (let i=0;i<bin.length;i++) buf[i]=bin.charCodeAt(i);
  return new Blob([buf], {type:"image/jpeg"});
}
async function writeInPlace(){
  const it = state.filtered[state.currentIdx];
  if (!state.writeGranted){ alert("No hay permiso de escritura en la carpeta."); return; }
  if (!(/jpe?g$/i.test(it.name) || it.type==="image/jpeg")){
    alert("Solo JPG admite escritura EXIF directa. Usa 'Descargar copia' para otros formatos.");
    return;
  }
  try{
    const meta = readForm();
    const blob = await buildJpegWithExif(it.file, meta);
    const writable = await it.handle.createWritable({ keepExistingData:false });
    await writable.write(blob);
    await writable.close();
    alert("¬°Metadatos guardados dentro del JPG!");
    // refresca
    const file = await it.handle.getFile();
    it.file = file;
    if (it.url) URL.revokeObjectURL(it.url);
    it.url = URL.createObjectURL(file);
    it.meta = await readMeta(file);
    $("#big").src = it.url;
    renderGrid();
  }catch(e){
    console.error(e);
    alert("No se pudo escribir en el archivo. Android puede bloquear carpetas del sistema/c√°mara. Prueba en una subcarpeta propia (Downloads/...).");
  }
}

/* --- Descargar copia con EXIF --- */
async function downloadCopy(){
  const it = state.filtered[state.currentIdx];
  const meta = readForm();
  if (/jpe?g$/i.test(it.name) || it.type==="image/jpeg"){
    const blob = await buildJpegWithExif(it.file, meta);
    saveBlob(blob, it.name.replace(/\.jpe?g$/i,"")+"_meta.jpg");
  }else{
    const jpgBlob = await rasterizeToJpeg(it.file);
    const withExif = await buildJpegWithExif(jpgBlob, meta);
    saveBlob(withExif, it.name.replace(/\.[^\.]+$/,"")+"_meta.jpg");
  }
}
function saveBlob(blob, name){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

/* --- Utilidades --- */
function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file);
  });
}
async function rasterizeToJpeg(file){
  const dataURL = await fileToDataURL(file);
  const img = new Image(); img.src = dataURL;
  await img.decode();
  const canvas = document.createElement("canvas");
  canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
  const ctx = canvas.getContext("2d"); ctx.drawImage(img,0,0);
  const blob = await new Promise(r=>canvas.toBlob(r,"image/jpeg",0.92));
  return blob;
}
</script>
</body>
</html>