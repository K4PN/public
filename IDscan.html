<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Captura solo documento</title>
<style>
  body,html{margin:0;height:100%;background:#000;color:#fff;font-family:sans-serif}
  .app{display:flex;flex-direction:column;height:100%}
  .stage{flex:1;position:relative;overflow:hidden}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .id-frame{
    width:min(88vw,88vh*1.585);aspect-ratio:1.585/1;border-radius:12px;
    box-shadow:0 0 0 3px rgba(255,255,255,.9),0 0 0 8px rgba(255,255,255,.15);
    position:relative;overflow:hidden;
  }
  .wm-tile{
    position:absolute;inset:0;opacity:.35;transform:rotate(var(--wm-angle,-15deg));
    background-size:var(--wm-step,220px) var(--wm-step,180px);
    background-repeat:repeat;background-position:center
  }
  .controls{padding:10px;background:#111;display:flex;gap:10px}
  .btn{flex:1;padding:12px;font-weight:bold;border:none;border-radius:8px;cursor:pointer}
  .primary{background:#4ade80;color:#062d12}
  .secondary{background:#333;color:#eee}
  input[type=text]{flex:2;padding:10px;border-radius:8px;border:1px solid #444;background:#222;color:#fff}
</style>
</head>
<body>
<div class="app">
  <div class="stage" id="stage">
    <video id="video" autoplay playsinline muted></video>
    <div class="overlay">
      <div class="id-frame" id="idFrame">
        <div class="wm-tile" id="wmTile"></div>
      </div>
    </div>
  </div>
  <div class="controls">
    <button class="btn primary" id="startBtn">Iniciar cámara</button>
    <button class="btn secondary" id="shotBtn" disabled>Capturar</button>
  </div>
  <div class="controls">
    <input id="wmText" type="text" placeholder="Marca de agua" />
  </div>
</div>

<script>
const video=document.getElementById("video");
const startBtn=document.getElementById("startBtn");
const shotBtn=document.getElementById("shotBtn");
const wmText=document.getElementById("wmText");
const wmTile=document.getElementById("wmTile");
const idFrame=document.getElementById("idFrame");

let stream;

function svgBgDataURI(text,fontPx,opacity){
  const esc=s=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const fill=`rgba(255,255,255,${opacity})`;
  const stepX=Math.round(fontPx*8), stepY=Math.round(fontPx*6.5);
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${stepX}' height='${stepY}'>
    <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
      font-family='system-ui,sans-serif' font-size='${fontPx}' font-weight='800' fill='${fill}'>
      ${esc(text)}
    </text></svg>`;
  return "url(\"data:image/svg+xml,"+encodeURIComponent(svg)+"\")";
}
function applyWatermark(){
  const t=(wmText.value.trim()||"MUESTRA").toUpperCase();
  const fontPx=24, opacity=0.35, angle=-15;
  wmTile.style.setProperty("--wm-angle",angle+"deg");
  wmTile.style.setProperty("--wm-step",Math.round(fontPx*8)+"px");
  wmTile.style.backgroundImage=svgBgDataURI(t,fontPx,opacity);
}
wmText.addEventListener("input",applyWatermark);

async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    await video.play();
    shotBtn.disabled=false;
  }catch(e){alert("Error cámara: "+e.message);}
}
startBtn.addEventListener("click",startCamera);

function capture(){
  if(!video.videoWidth){alert("Cámara no lista");return;}
  // tamaño del recuadro documento
  const rect=idFrame.getBoundingClientRect();
  const stageRect=document.getElementById("stage").getBoundingClientRect();
  const W=rect.width,H=rect.height;
  const canvas=document.createElement("canvas");
  canvas.width=W*devicePixelRatio;
  canvas.height=H*devicePixelRatio;
  const ctx=canvas.getContext("2d");
  ctx.scale(devicePixelRatio,devicePixelRatio);
  // recorte del vídeo correspondiente al documento
  const scale=video.videoWidth/stageRect.width;
  const sx=(rect.left-stageRect.left)*scale;
  const sy=(rect.top-stageRect.top)*scale;
  const sw=rect.width*scale;
  const sh=rect.height*scale;
  ctx.drawImage(video,sx,sy,sw,sh,0,0,W,H);
  // aplicar marca de agua en mosaico
  const fontPx=24,opacity=0.35,angle=-15;
  const tileW=fontPx*8,tileH=fontPx*6.5;
  const pCan=document.createElement("canvas");pCan.width=tileW;pCan.height=tileH;
  const pCtx=pCan.getContext("2d");
  pCtx.font=`800 ${fontPx}px system-ui,sans-serif`;
  pCtx.textAlign="center";pCtx.textBaseline="middle";
  pCtx.fillStyle=`rgba(255,255,255,${opacity})`;
  pCtx.fillText((wmText.value.trim()||"MUESTRA").toUpperCase(),tileW/2,tileH/2);
  const pattern=ctx.createPattern(pCan,"repeat");
  ctx.save();
  ctx.translate(W/2,H/2);
  ctx.rotate(angle*Math.PI/180);
  ctx.translate(-W/2,-H/2);
  ctx.fillStyle=pattern;
  ctx.fillRect(0,0,W,H);
  ctx.restore();
  // descargar
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="documento.png";a.click();
}
shotBtn.addEventListener("click",capture);

applyWatermark();
</script>
</body>
</html>