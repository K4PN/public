<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAPACHE OSINT BOT ¬∑ Asuntos ‚Üí PDF</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg0:#070912;
      --bg1:#0b1022;
      --card:#0f1631;
      --card2:#0a1027;
      --text:#eef2ff;
      --muted:#aeb6d6;
      --border:rgba(255,255,255,.10);

      --accent:#c8986b;
      --accent2:#d4ab7f;

      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 20px;

      --ok: rgba(85, 255, 170, .18);
      --warn: rgba(255, 215, 120, .16);
      --danger: rgba(255, 90, 106, .16);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;

      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(200,152,107,.18), transparent 55%),
        radial-gradient(900px 700px at 85% 0%, rgba(212,171,127,.12), transparent 52%),
        radial-gradient(900px 600px at 60% 120%, rgba(110,160,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{
      width:min(980px, 100%);
      display:grid;
      gap:16px;
    }

    .card{
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border:1px solid var(--border);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      position:relative;
    }

    /* brillo suave */
    .card:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 240px at 30% -20%, rgba(212,171,127,.16), transparent 60%);
      pointer-events:none;
    }

    header{
      position:relative;
      padding:18px 18px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      background:
        linear-gradient(180deg, rgba(200,152,107,.13), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,0));
      border-bottom: 1px solid var(--border);
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(200,152,107,.26), rgba(200,152,107,.10));
      border:1px solid rgba(200,152,107,.35);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }

    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.3px;
      line-height:1.25;
    }
    .brand p{
      margin:4px 0 0 0;
      color:var(--muted);
      font-size: 13px;
      line-height:1.35;
      max-width: 58ch;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
      width: fit-content;
    }

    .btnbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:flex-start;
      position:relative;
      z-index:2;
    }

    button{
      appearance:none;
      border:1px solid rgba(200,152,107,.40);
      background: linear-gradient(180deg, rgba(200,152,107,.26), rgba(200,152,107,.10));
      color:var(--text);
      padding:10px 14px;
      border-radius: 14px;
      font-weight: 700;
      letter-spacing:.2px;
      cursor:pointer;
      transition: transform .08s ease, filter .15s ease, border-color .15s ease;
      user-select:none;
      box-shadow: 0 10px 30px rgba(0,0,0,.30);
    }
    button:hover{ filter:brightness(1.07); border-color: rgba(212,171,127,.65); }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter:saturate(.6);
      box-shadow:none;
    }

    .ghost{
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      color:var(--muted);
      font-weight:650;
      box-shadow:none;
    }

    .content{
      padding:18px;
      background: linear-gradient(180deg, rgba(0,0,0,.00), rgba(0,0,0,.16));
      position:relative;
      z-index:1;
    }

    .panel{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      border-radius: 16px;
      padding:14px;
    }

    .grid{ display:grid; gap:12px; }

    .label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .label span{
      font-size: 13px;
      color: var(--muted);
    }

    textarea{
      width:100%;
      min-height: 220px;
      resize: vertical;
      padding:12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(6, 8, 16, .60);
      color: var(--text);
      outline: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      line-height:1.45;
    }
    textarea:focus{ border-color: rgba(212,171,127,.65); }

    .hint{
      color:var(--muted);
      font-size: 12.5px;
      line-height:1.35;
      margin-top:10px;
    }

    .error{
      margin-top:10px;
      color: #ffd1d6;
      background: var(--danger);
      border:1px solid rgba(255,90,106,.35);
      padding:10px 12px;
      border-radius: 14px;
      font-size: 13px;
      display:none;
      white-space: pre-wrap;
    }

    .report{ display:none; }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }

    .kv{
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:10px 12px;
      position:relative;
      overflow:hidden;
    }
    .kv:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(400px 120px at 20% 0%, rgba(200,152,107,.14), transparent 60%);
      pointer-events:none;
    }

    .kv .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom:6px;
      position:relative;
      z-index:1;
    }
    .kv .v{
      font-size: 14px;
      font-weight: 750;
      overflow-wrap:anywhere;
      position:relative;
      z-index:1;
    }

    .items{
      display:grid;
      gap:10px;
    }

    .item{
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding:12px;
    }

    .item .t{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom:10px;
    }

    .item .x{
      font-size: 14px;
      line-height:1.45;
      overflow-wrap:anywhere;
      white-space:pre-wrap;
    }

    .imgwrap{
      margin-top:10px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }
    .imgwrap img{
      display:block;
      width:100%;
      height:auto;
      max-height: 360px;
      object-fit: contain;
    }
    .imgnote{
      padding:8px 10px;
      font-size:12px;
      color: var(--muted);
      border-top:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.22);
    }

    .footerline{
      margin-top:12px;
      color: var(--muted);
      font-size: 12px;
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px; height:8px; border-radius: 99px;
      background: rgba(255,255,255,.25);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }
    .dot.ok{ background: rgba(85,255,170,.75); box-shadow: 0 0 0 4px rgba(85,255,170,.12); }
    .dot.warn{ background: rgba(255,215,120,.85); box-shadow: 0 0 0 4px rgba(255,215,120,.12); }

    @media (max-width: 680px){
      .meta{ grid-template-columns: 1fr; }
      header{ flex-direction:column; align-items:stretch; }
      .btnbar{ justify-content:stretch; }
      button{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true">ü¶ù</div>
          <div>
            <h1>MAPACHE OSINT BOT ¬∑ Asuntos ‚Üí Exportar a PDF</h1>
            <p>Pega tu JSON exportado y genera un PDF con toda la informaci√≥n. Vista previa incluida (con im√°genes si detecta enlaces directos).</p>
            <div class="pill">üîí Todo se procesa localmente en tu navegador</div>
          </div>
        </div>

        <div class="btnbar">
          <button id="mainBtn">Pegar JSON</button>
          <button id="resetBtn" class="ghost" style="display:none;">Reset</button>
        </div>
      </header>

      <div class="content">
        <!-- Panel pegado JSON -->
        <div id="pastePanel" class="panel grid" style="display:none;">
          <div class="label">
            <span>Pega aqu√≠ el JSON (objeto completo)</span>
            <span class="statusPill" id="statusPill">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Esperando JSON</span>
            </span>
          </div>

          <textarea id="jsonInput" spellcheck="false" placeholder='Ej:
{
  "asunto": {
    "id": 1,
    "titulo": "Operaci√≥n Ejemplo",
    "created_at": 1770073772,
    "items": [
      {"texto":"https://sitio/foto.jpg", "created_at": 1770073822}
    ]
  }
}'></textarea>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <button id="loadBtn">Cargar JSON</button>
          </div>

          <div class="hint">
            Formato esperado: <code>{"asunto":{"id":...,"titulo":...,"created_at":...,"items":[...]}}</code><br/>
            <b>created_at</b> puede venir como epoch (segundos/ms) o ISO.
          </div>

          <div id="errorBox" class="error"></div>
        </div>

        <!-- Report -->
        <div id="report" class="report">
          <div class="meta">
            <div class="kv">
              <div class="k">T√≠tulo</div>
              <div class="v" id="rTitulo">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">ID</div>
              <div class="v" id="rId">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">Creado</div>
              <div class="v" id="rCreated">‚Äî</div>
            </div>
            <div class="kv">
              <div class="k">Items</div>
              <div class="v" id="rCount">‚Äî</div>
            </div>
          </div>

          <div class="items" id="itemsBox"></div>

          <div class="footerline">
            Nota: el PDF se genera localmente. Si una imagen externa no permite CORS, se ver√° en la vista previa, pero puede que en el PDF quede solo el enlace.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Estado
    // ----------------------------
    let loadedData = null;

    // ----------------------------
    // Helpers UI
    // ----------------------------
    function show(el){ el.style.display = ""; }
    function hide(el){ el.style.display = "none"; }

    function setStatus(type, text){
      const dot = document.getElementById("statusDot");
      const t = document.getElementById("statusText");
      dot.className = "dot" + (type ? (" " + type) : "");
      t.textContent = text || "";
    }

    function setError(msg){
      const box = document.getElementById("errorBox");
      box.textContent = msg;
      box.style.display = "block";
      setStatus("warn", "Error en JSON");
    }
    function clearError(){
      const box = document.getElementById("errorBox");
      box.textContent = "";
      box.style.display = "none";
      setStatus("", "Esperando JSON");
    }

    // ----------------------------
    // Helpers datos
    // ----------------------------
    function isObject(v){
      return v && typeof v === "object" && !Array.isArray(v);
    }

    function parseDateAny(value){
      if (value === null || value === undefined) return null;

      if (typeof value === "number" || (typeof value === "string" && /^\d+$/.test(value.trim()))) {
        const n = (typeof value === "number") ? value : Number(value.trim());
        const ms = n > 10_000_000_000 ? n : n * 1000; // ms o sec
        const d = new Date(ms);
        return isNaN(d.getTime()) ? null : d;
      }

      if (typeof value === "string") {
        const d = new Date(value);
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }

    function fmtDate(d){
      if (!d) return "‚Äî";
      return d.toLocaleString("es-ES", {
        year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }

    function safeStr(v){
      if (v === null || v === undefined) return "";
      return String(v);
    }

    // Detecta URLs dentro de un texto (simple pero eficaz)
    function extractUrls(text){
      if (!text) return [];
      const re = /\bhttps?:\/\/[^\s<>"')\]]+/gi;
      const m = text.match(re);
      return m ? m : [];
    }

    function isImageUrl(url){
      try{
        const u = new URL(url);
        const p = u.pathname.toLowerCase();
        return (
          p.endsWith(".png") || p.endsWith(".jpg") || p.endsWith(".jpeg") ||
          p.endsWith(".webp") || p.endsWith(".gif")
        );
      }catch{
        // fallback por si no es URL v√°lida
        const s = url.toLowerCase();
        return /\.(png|jpe?g|webp|gif)(\?|#|$)/i.test(s);
      }
    }

    function normalizeData(raw){
      if (!isObject(raw)) throw new Error("El JSON debe ser un objeto ra√≠z (no una lista).");

      const asunto = raw.asunto;
      if (!isObject(asunto)) throw new Error("Falta el objeto 'asunto' o no es v√°lido.");

      const id = asunto.id;
      const titulo = asunto.titulo;
      const created = parseDateAny(asunto.created_at);

      if (id === undefined || id === null) throw new Error("Falta 'asunto.id'.");
      if (!titulo) throw new Error("Falta 'asunto.titulo'.");
      if (!created) throw new Error("No pude interpretar 'asunto.created_at' (epoch/ISO).");

      const items = Array.isArray(asunto.items) ? asunto.items : [];
      const normItems = items.map((it, idx) => {
        if (!isObject(it)) {
          return { texto: "[Item inv√°lido]", created_at: null, idx, imageUrl: null };
        }
        const texto = safeStr(it.texto || "");
        const d = parseDateAny(it.created_at);

        // Si hay URLs, y alguna es imagen, nos quedamos con la primera imagen
        const urls = extractUrls(texto);
        const img = urls.find(u => isImageUrl(u)) || null;

        return { texto, created_at: d, idx, imageUrl: img };
      });

      return {
        id: safeStr(id),
        titulo: safeStr(titulo),
        created_at: created,
        items: normItems
      };
    }

    // ----------------------------
    // UI render
    // ----------------------------
    function renderReport(data){
      document.getElementById("rTitulo").textContent = data.titulo;
      document.getElementById("rId").textContent = data.id;
      document.getElementById("rCreated").textContent = fmtDate(data.created_at);
      document.getElementById("rCount").textContent = String(data.items.length);

      const box = document.getElementById("itemsBox");
      box.innerHTML = "";

      data.items.forEach((it, i) => {
        const div = document.createElement("div");
        div.className = "item";

        const t = document.createElement("div");
        t.className = "t";
        const left = document.createElement("div");
        left.textContent = `#${i+1} ¬∑ ${it.created_at ? fmtDate(it.created_at) : "fecha desconocida"}`;
        const right = document.createElement("div");
        right.textContent = it.imageUrl ? "üñºÔ∏è imagen detectada" : "‚Äî";
        t.appendChild(left);
        t.appendChild(right);

        const x = document.createElement("div");
        x.className = "x";
        x.textContent = it.texto || "‚Äî";

        div.appendChild(t);
        div.appendChild(x);

        // Si hay imagen, la mostramos debajo
        if (it.imageUrl){
          const wrap = document.createElement("div");
          wrap.className = "imgwrap";

          const img = document.createElement("img");
          img.alt = "Imagen detectada";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer"; // ayuda en algunos hosts
          img.src = it.imageUrl;

          const note = document.createElement("div");
          note.className = "imgnote";
          note.textContent = it.imageUrl;

          wrap.appendChild(img);
          wrap.appendChild(note);
          div.appendChild(wrap);
        }

        box.appendChild(div);
      });

      show(document.getElementById("report"));
    }

    function setModePaste(){
      const mainBtn = document.getElementById("mainBtn");
      mainBtn.textContent = "Pegar JSON";
      mainBtn.disabled = false;
      hide(document.getElementById("resetBtn"));
      hide(document.getElementById("report"));
      hide(document.getElementById("pastePanel"));
      loadedData = null;
      clearError();
      document.getElementById("jsonInput").value = "";
      setStatus("", "Esperando JSON");
    }

    function setModeExportReady(){
      const mainBtn = document.getElementById("mainBtn");
      mainBtn.textContent = "Exportar PDF";
      mainBtn.disabled = false;
      show(document.getElementById("resetBtn"));
      hide(document.getElementById("pastePanel"));
      setStatus("ok", "Listo para exportar");
    }

    // ----------------------------
    // Imagen ‚Üí dataURL (para PDF)
    // ----------------------------
    async function imageUrlToDataUrl(url, maxW = 360){
      // OJO: puede fallar por CORS. En ese caso devolvemos null.
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // si el host permite CORS, funcionar√°
        img.onload = () => {
          try{
            const scale = Math.min(1, maxW / img.width);
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);

            const c = document.createElement("canvas");
            c.width = w; c.height = h;
            const ctx = c.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);
            const dataUrl = c.toDataURL("image/jpeg", 0.85);
            resolve({ dataUrl, w, h });
          }catch{
            resolve(null);
          }
        };
        img.onerror = () => resolve(null);
        img.src = url;
      });
    }

    // ----------------------------
    // PDF export (con intento de im√°genes)
    // ----------------------------
    async function exportPDF(data){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"p", unit:"pt", format:"a4" });

      const margin = 44;
      let y = margin;

      // Header (branding)
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("MAPACHE OSINT BOT", margin, y);
      y += 14;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text(data.titulo, margin, y);
      y += 18;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      doc.text(`ID: ${data.id}`, margin, y);
      y += 14;
      doc.text(`Creado: ${fmtDate(data.created_at)}`, margin, y);
      y += 18;

      doc.setDrawColor(200);
      doc.line(margin, y, 595 - margin, y);
      y += 14;

      // Pre-cargar im√°genes (si hay) para poder insertarlas en el PDF
      const imageMap = new Map(); // key: rowIndex -> {dataUrl,w,h} | null
      const rows = [];

      for (let idx = 0; idx < data.items.length; idx++){
        const it = data.items[idx];

        let textoCell = it.texto || "‚Äî";
        if (it.imageUrl){
          // intentamos convertir a dataURL
          const imgData = await imageUrlToDataUrl(it.imageUrl, 360);
          imageMap.set(idx, imgData); // puede ser null si CORS falla

          if (imgData){
            textoCell = "[imagen incrustada]";
          } else {
            textoCell = `${it.texto}\n\n[No se pudo incrustar imagen por CORS]\n${it.imageUrl}`;
          }
        }

        rows.push([
          String(idx + 1),
          it.created_at ? fmtDate(it.created_at) : "‚Äî",
          textoCell
        ]);
      }

      doc.autoTable({
        startY: y,
        head: [["#", "Fecha", "Texto"]],
        body: rows,
        theme: "grid",
        styles: {
          font: "helvetica",
          fontSize: 9.5,
          cellPadding: 6,
          overflow: "linebreak",
          valign: "top"
        },
        headStyles: { fontStyle: "bold" },
        columnStyles: {
          0: { cellWidth: 26 },
          1: { cellWidth: 120 },
          2: { cellWidth: 595 - (margin*2) - 26 - 120 }
        },
        margin: { left: margin, right: margin },

        // Insertar imagen dentro de la celda "Texto" si existe dataURL
        didDrawCell: function (hook){
          const col = hook.column.index;
          const row = hook.row.index; // 0..n-1 en body
          if (hook.section !== "body") return;
          if (col !== 2) return;

          const imgData = imageMap.get(row);
          if (!imgData) return; // null o undefined -> no hay imagen embebible

          // La celda donde dibujar
          const cell = hook.cell;
          const pad = 6;

          // Calculamos tama√±o para que quepa
          const maxW = cell.width - pad*2;
          const maxH = 120; // altura m√°xima razonable dentro de la celda
          const ratio = Math.min(maxW / imgData.w, maxH / imgData.h, 1);

          const drawW = imgData.w * ratio;
          const drawH = imgData.h * ratio;

          const x = cell.x + pad;
          const y = cell.y + pad + 10;

          try{
            doc.addImage(imgData.dataUrl, "JPEG", x, y, drawW, drawH);
          }catch{
            // si falla por cualquier motivo, no hacemos nada (queda el texto)
          }
        },

        // Ajustamos altura m√≠nima de filas con imagen embebida
        didParseCell: function (hook){
          if (hook.section !== "body") return;
          if (hook.column.index !== 2) return;
          const row = hook.row.index;
          const imgData = imageMap.get(row);
          if (imgData){
            hook.cell.styles.minCellHeight = 150;
          }
        }
      });

      // Footer
      const pages = doc.getNumberOfPages();
      for (let p = 1; p <= pages; p++) {
        doc.setPage(p);
        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text(`MAPACHE OSINT BOT ¬∑ Generado localmente ¬∑ P√°gina ${p} / ${pages}`, margin, 842 - 26);
      }

      const safeTitle = (data.titulo || "asunto")
        .replace(/[\\/:*?"<>|]/g, "_")
        .replace(/\s+/g, " ")
        .trim();

      doc.save(`${safeTitle}.pdf`);
    }

    // ----------------------------
    // Eventos
    // ----------------------------
    document.getElementById("mainBtn").addEventListener("click", async () => {
      const mainBtn = document.getElementById("mainBtn");

      if (mainBtn.textContent === "Pegar JSON") {
        show(document.getElementById("pastePanel"));
        document.getElementById("jsonInput").focus();
        setStatus("", "Pegando JSON‚Ä¶");
        return;
      }

      if (mainBtn.textContent === "Exportar PDF") {
        if (!loadedData) return;
        mainBtn.disabled = true;
        mainBtn.textContent = "Generando‚Ä¶";
        try{
          await exportPDF(loadedData);
        } finally {
          mainBtn.disabled = false;
          mainBtn.textContent = "Exportar PDF";
        }
      }
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      setModePaste();
    });

    document.getElementById("loadBtn").addEventListener("click", () => {
      clearError();
      const text = document.getElementById("jsonInput").value.trim();
      if (!text) return setError("Pega el JSON antes de cargar.");

      try{
        setStatus("", "Cargando‚Ä¶");
        const raw = JSON.parse(text);
        const norm = normalizeData(raw);

        loadedData = norm;
        renderReport(norm);
        setModeExportReady();

      }catch(e){
        setError("No pude cargar el JSON.\n\n" + (e && e.message ? e.message : String(e)));
      }
    });

    // Inicia en modo "Pegar JSON"
    setModePaste();
  </script>
</body>
</html>
