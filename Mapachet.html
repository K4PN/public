<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Chat P2P — QR</title>
<style>
  :root{--bg:#f7f7fb;--panel:#fff;--ink:#1f2937;--muted:#6b7280;--accent:#3b82f6;--soft:#e5f0ff;--border:#e5e7eb}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
  .app{display:grid;grid-template-columns:0 1fr;height:100dvh;overflow:hidden}
  .app.menu-open{grid-template-columns:78vw 1fr}
  aside{background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
  .side-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between}
  .side-title{font-weight:700}
  .conv-list{overflow:auto;flex:1}
  .conv{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .conv.active{background:var(--soft)}
  .conv .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .conv .meta{font-size:12px;color:var(--muted)}
  .btn,button{border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;box-shadow:0 2px 6px rgba(59,130,246,.18)}
  .btn-ghost{background:transparent;color:var(--accent)}
  button[disabled]{opacity:.55;filter:grayscale(.2)}
  main{display:flex;flex-direction:column;min-width:0}
  .topbar{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .hamb{width:40px;height:40px;border-radius:12px;background:#f0f4ff;border:1px solid var(--border);display:grid;place-items:center}
  .hamb span{width:18px;height:2px;background:var(--ink);position:relative;display:block}
  .hamb span::before,.hamb span::after{content:"";position:absolute;left:0;width:18px;height:2px;background:var(--ink)}
  .hamb span::before{top:-6px}.hamb span::after{top:6px}
  .id-chip{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:56vw}
  .status{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .on{border-color:#c7f9d2;background:#eeffef;color:#0a7a2a}
  .warn{padding:8px 12px;background:#fff7ed;color:#92400e;border:1px solid #fed7aa;border-left-width:4px;border-radius:10px;margin:8px 12px}
  .messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(#f8fbff,#f7f7fb)}
  .bubble{max-width:80%;padding:10px 12px;border-radius:14px;margin:6px 0;word-wrap:break-word;background:#fff;border:1px solid var(--border)}
  .me{margin-left:auto;background:var(--accent);color:#fff;border-color:transparent}
  .meta-time{display:block;margin-top:6px;font-size:11px;opacity:.8}
  .composer{padding:10px;background:var(--panel);border-top:1px solid var(--border);display:flex;gap:8px}
  .composer input{flex:1;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;background:#fff}
  .composer button{padding:12px 16px;border-radius:12px}
  .connect{padding:10px;border-top:1px dashed var(--border);background:#fbfcff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qr-wrap{display:grid;place-items:center;padding:10px}
  #qrCanvas{background:#fff;padding:10px;border:1px solid var(--border);border-radius:12px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:10px}
  .modal.open{display:flex}
  .sheet{background:#000;border-radius:16px;max-width:520px;width:100%;overflow:hidden;display:flex;flex-direction:column}
  .sheet-header{color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.06)}
  .sheet-main{position:relative}
  video{width:100%;height:auto;display:block;background:#000}
  .scan-box{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .box{width:68vmin;height:68vmin;max-width:84%;max-height:84%;border:2px solid rgba(255,255,255,.9);border-radius:16px;box-shadow:0 0 0 200vmax rgba(0,0,0,.35) inset}
  .sheet-footer{padding:10px;display:flex;gap:8px;justify-content:space-between;background:#000}
  .sheet-footer .hint{color:#cbd5e1;font-size:12px}
  .switch{background:#1f2937;color:#fff;border:1px solid #374151;border-radius:10px;padding:8px 12px}
  .errbar{position:fixed;top:0;left:0;right:0;padding:10px;background:#fee2e2;color:#7f1d1d;border-bottom:1px solid #fecaca;font-size:12px;display:none;z-index:9999}
</style>

<!-- Dependencias ligeras (CDN) para mantener 1 solo HTML y QR robusto -->
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
</head>
<body>
<div class="errbar" id="errbar"></div>
<div class="app" id="app">
  <aside>
    <div class="side-header">
      <div>
        <div class="side-title">Conversaciones</div>
        <div style="font-size:12px;color:#6b7280">Guardadas en este dispositivo</div>
      </div>
      <button class="btn-ghost" id="newConvBtn" type="button">＋</button>
    </div>
    <div class="conv-list" id="convList"></div>
  </aside>

  <main>
    <div class="topbar">
      <button class="hamb" id="hamb" type="button" aria-label="Abrir menú"><span></span></button>
      <div class="id-chip" id="myIdChip">ID: …</div>
      <div class="status" id="netStatus">Desconectado</div>
    </div>

    <div id="secureWarn" class="warn" style="display:none"></div>

    <section class="connect">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:6px">
          <button id="offerBtn" type="button">Crear oferta (QR)</button>
          <button id="scanBtn" type="button">Escanear QR</button>
        </div>
        <button id="clearQRBtn" class="btn-ghost" type="button">Limpiar</button>
      </div>
      <div class="qr-wrap">
        <canvas id="qrCanvas" width="256" height="256"></canvas>
        <div class="hint" style="margin-top:6px;color:#6b7280;font-size:12px">Muestra este QR o escanéalo desde el otro móvil.</div>
      </div>
    </section>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="msgInput" placeholder="Mensaje…" autocomplete="off" />
      <button id="sendBtn" type="button">Enviar</button>
    </div>
  </main>
</div>

<!-- Modal escáner -->
<div class="modal" id="scanModal" role="dialog" aria-modal="true" aria-label="Escanear QR">
  <div class="sheet">
    <div class="sheet-header">
      <div>Escanea el QR</div>
      <button id="closeScan" class="switch" type="button">Cerrar</button>
    </div>
    <div class="sheet-main">
      <video id="video" playsinline></video>
      <div class="scan-box"><div class="box"></div></div>
    </div>
    <div class="sheet-footer">
      <div class="hint">Coloca el QR dentro del recuadro</div>
      <button id="switchCam" class="switch" type="button">Cambiar cámara</button>
    </div>
  </div>
</div>

<script>
(() => {
/* ========= Barra de errores global ========= */
const errbar = document.getElementById('errbar');
const showErr = (msg)=>{ errbar.innerHTML='⚠️ '+msg; errbar.style.display='block'; };
window.addEventListener('error', e=> showErr((e.message||'Error')+' @ '+(e.filename||'')+':'+(e.lineno||'')));
window.addEventListener('unhandledrejection', e=> showErr('Promise rechazada: '+(e.reason?.message||e.reason||'')));

/* ========= Utiles ========= */
const $ = s => document.querySelector(s);
const app = $("#app");
$("#hamb").onclick = ()=> app.classList.toggle("menu-open");
const secure = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
function busy(btn, on){ if(btn) btn.disabled=!!on; }
function setStatus(on){ const el=$("#netStatus"); el.textContent=on?"Conectado":"Desconectado"; el.classList.toggle("on",!!on); }
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}
function addBubble(direction, text, at){
  const wrap=$("#messages");
  const b=document.createElement("div");
  b.className="bubble"+(direction==="out"?" me":"");
  b.innerHTML=`${escapeHtml(text)}<span class="meta-time">${new Date(at).toLocaleString()}</span>`;
  wrap.appendChild(b); wrap.scrollTop=wrap.scrollHeight;
}

/* ========= Aviso contexto ========= */
(function(){
  const warn=$("#secureWarn"); const notes=[];
  if(!secure) notes.push("Abre en <b>HTTPS</b> o <b>localhost</b> (cámara/WebRTC requieren contexto seguro).");
  warn.innerHTML=notes.join("<br>"); warn.style.display=notes.length?"block":"none";
})();

/* ========= Fingerprint ID ========= */
async function sha256(x){ const buf=new TextEncoder().encode(x); const h=await crypto.subtle.digest("SHA-256",buf); return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,"0")).join(""); }
function getCanvasFP(){ try{ const c=document.createElement('canvas'); c.width=200;c.height=40; const ctx=c.getContext('2d'); ctx.textBaseline='top'; ctx.font='16px Arial'; ctx.fillStyle='#f60'; ctx.fillRect(0,0,200,40); ctx.fillStyle='#069'; ctx.fillText(navigator.userAgent,2,2); return c.toDataURL(); }catch{ return 'nocanvas'; } }
async function computeDeviceId(){
  let salt=localStorage.getItem("p2p_salt"); if(!salt){ salt=crypto.getRandomValues(new Uint32Array(4)).join("-"); localStorage.setItem("p2p_salt",salt); }
  const bits=[navigator.userAgent||"",navigator.language||"",Intl.DateTimeFormat().resolvedOptions().timeZone||"",screen.width+"x"+screen.height+"x"+(screen.colorDepth||0),(navigator.hardwareConcurrency||0)+"",(navigator.deviceMemory||0)+"",getCanvasFP(),salt].join("|");
  const id=await sha256(bits); localStorage.setItem("p2p_myId",id); return id;
}

/* ========= IndexedDB ========= */
const DB="p2pchatdb", VER=1; let db;
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,VER);
  r.onupgradeneeded=e=>{ const d=e.target.result;
    if(!d.objectStoreNames.contains("conversations")) d.createObjectStore("conversations",{keyPath:"peerId"});
    if(!d.objectStoreNames.contains("messages")){ const s=d.createObjectStore("messages",{keyPath:"id",autoIncrement:true}); s.createIndex("byPeer","peerId",{}); }
  };
  r.onsuccess=()=>{ db=r.result; res(); }; r.onerror=()=>rej(r.error);
});}
function saveConversation(peerId,lastText=""){ return new Promise((res,rej)=>{ const tx=db.transaction("conversations","readwrite"); const st=tx.objectStore("conversations");
  st.get(peerId).onsuccess=ev=>{ const now=Date.now(); const old=ev.target.result; const rec=old?{...old,lastAt:now,lastText}:{peerId,createdAt:now,lastAt:now,lastText}; st.put(rec).onsuccess=()=>res(rec); };
  tx.onerror=()=>rej(tx.error);
});}
function listConversations(){ return new Promise((res,rej)=>{ const tx=db.transaction("conversations","readonly"); const st=tx.objectStore("conversations"); const arr=[];
  st.openCursor().onsuccess=ev=>{ const c=ev.target.result; if(c){arr.push(c.value); c.continue();} else { arr.sort((a,b)=>(b.lastAt||0)-(a.lastAt||0)); res(arr);} };
  tx.onerror=()=>rej(tx.error);
});}
function saveMessage(peerId, dir, text){ return new Promise((res,rej)=>{ const tx=db.transaction(["messages","conversations"],"readwrite");
  const m=tx.objectStore("messages"), c=tx.objectStore("conversations"); const msg={peerId,direction:dir,text,at:Date.now()};
  m.add(msg).onsuccess=()=>{ c.get(peerId).onsuccess=ev=>{ const old=ev.target.result||{peerId,createdAt:Date.now()}; old.lastAt=msg.at; old.lastText=text; c.put(old); }; res(msg); };
  tx.onerror=()=>rej(tx.error);
});}
function loadMessages(peerId){ return new Promise((res,rej)=>{ const tx=db.transaction("messages","readonly"); const st=tx.objectStore("messages"); const idx=st.index("byPeer"); const req=idx.getAll(peerId);
  req.onsuccess=()=>{ const arr=req.result.sort((a,b)=>(a.at||0)-(b.at||0)); res(arr); }; req.onerror=()=>rej(req.error);
});}
async function renderConversationList(){
  const list=$("#convList"); list.innerHTML=""; const items=await listConversations();
  for(const c of items){
    const div=document.createElement("div"); div.className="conv"+(state.currentPeer===c.peerId?" active":"");
    const name=document.createElement("div"); name.className="name"; name.textContent=c.peerId.slice(0,12);
    const meta=document.createElement("div"); meta.className="meta"; meta.textContent=(c.lastText||"").slice(0,24)||"—";
    div.appendChild(name); div.appendChild(meta);
    div.onclick=async()=>{ state.currentPeer=c.peerId; await openChat(state.currentPeer); app.classList.remove("menu-open"); };
    list.appendChild(div);
  }
}
async function openChat(peerId){
  $("#messages").innerHTML="";
  const msgs=await loadMessages(peerId);
  msgs.forEach(m=> addBubble(m.direction==="out"?"out":"in",m.text,m.at));
  await renderConversationList();
}

/* ========= Estado ========= */
const state = { pc:null, dc:null, currentPeer:null, MY_ID:"" };

/* ========= WebRTC ========= */
const RTC_CFG = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };
function resetPC(){
  if(state.pc) try{ state.pc.close(); }catch{}
  state.pc=new RTCPeerConnection(RTC_CFG);
  state.pc.oniceconnectionstatechange=()=>{ const st=state.pc.iceConnectionState; setStatus(st==="connected"||st==="completed"); };
  state.pc.ondatachannel=(ev)=>{ state.dc=ev.channel; bindDC(); };
}
function bindDC(){
  if(!state.dc) return;
  state.dc.onopen=()=>{ try{ state.dc.send(JSON.stringify({type:"hello", id:state.MY_ID})); }catch{} };
  state.dc.onmessage=async ev=>{
    const raw=String(ev.data||"");
    try{
      const hello=JSON.parse(raw);
      if(hello && hello.type==="hello" && hello.id){
        state.currentPeer=hello.id; await saveConversation(state.currentPeer,"¡Conectado!"); await renderConversationList(); return;
      }
    }catch{}
    const pid=state.currentPeer||"peer"; await saveConversation(pid,raw); await saveMessage(pid,"in",raw); addBubble("in",raw,Date.now()); renderConversationList();
  };
}
function waitGathering(){ return new Promise(res=>{ if(state.pc.iceGatheringState==="complete") return res(); state.pc.onicegatheringstatechange=()=>{ if(state.pc.iceGatheringState==="complete") res(); }; }); }
async function createOffer(){
  resetPC();
  state.dc=state.pc.createDataChannel("chat"); bindDC();
  const offer=await state.pc.createOffer(); await state.pc.setLocalDescription(offer); await waitGathering();
  return {kind:"offer", sdp: state.pc.localDescription};
}
async function acceptOffer(offerObj){
  resetPC();
  await state.pc.setRemoteDescription(offerObj.sdp);
  const answer=await state.pc.createAnswer(); await state.pc.setLocalDescription(answer); await waitGathering();
  return {kind:"answer", sdp: state.pc.localDescription};
}
async function acceptAnswer(ansObj){
  if(!state.pc) throw new Error("Crea primero una oferta en este dispositivo.");
  await state.pc.setRemoteDescription(ansObj.sdp);
}

/* ========= QR: compresión + generador robusto ========= */
function pack(str){ return LZString.compressToEncodedURIComponent(str); }
function unpack(packed){ return LZString.decompressFromEncodedURIComponent(packed||"") || ""; }

/* Dibuja en <canvas id="qrCanvas"> usando qrcode-generator (auto versión 1..40) */
const qrCanvas = document.getElementById('qrCanvas');
function drawPackedToCanvas(packed){
  const qr = qrcode(0, 'M'); // 0 => auto versión
  qr.addData(packed);
  qr.make();
  const ctx = qrCanvas.getContext('2d'), size = qrCanvas.width;
  const count = qr.getModuleCount(), cell = Math.floor(size/count), pad = Math.floor((size-cell*count)/2);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#000';
  for(let r=0;r<count;r++) for(let c=0;c<count;c++){
    if(qr.isDark(r,c)) ctx.fillRect(pad+c*cell, pad+r*cell, cell, cell);
  }
}
/* API usada por el resto del código (no cambia llamadas) */
function drawQRPayload(text){ drawPackedToCanvas(pack(text)); }
function parseQRString(raw){ const txt = unpack(raw) || raw; try{ return JSON.parse(txt); }catch{ return null; } }

/* ========= Lector con BarcodeDetector ========= */
const hasBD = 'BarcodeDetector' in window; let bd=null;
if(hasBD){ try{ bd=new BarcodeDetector({formats:['qr_code']}); }catch{} }

const scanModal=$("#scanModal"), video=$("#video"), closeScan=$("#closeScan"), switchCam=$("#switchCam");
let stream=null, useBack=true, rafId=null;

async function startScan(){
  if(!secure) return alert("Cámara requiere HTTPS/localhost.");
  if(!bd) return alert("Tu navegador no soporta lector QR nativo (BarcodeDetector).");
  try{
    stopScan();
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode: useBack?{ideal:'environment'}:'user'}, audio:false});
    video.srcObject=stream; await video.play(); scanModal.classList.add("open"); tickScan();
  }catch(e){ alert("No se pudo abrir la cámara: "+(e?.message||e)); }
}
function stopScan(){
  if(rafId) cancelAnimationFrame(rafId), rafId=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.pause(); video.srcObject=null; scanModal.classList.remove("open");
}
switchCam.onclick = async ()=>{ useBack=!useBack; await startScan(); };
closeScan.onclick = ()=> stopScan();

async function tickScan(){
  try{
    const codes = await bd.detect(video);
    if(codes && codes.length){
      stopScan();
      const obj = parseQRString(codes[0].rawValue||"");
      if(!obj) return alert("QR leído, pero no se pudo decodificar.");
      await handleScannedObject(obj);
      return;
    }
  }catch(e){ /* seguimos */ }
  rafId = requestAnimationFrame(tickScan);
}

/* ========= Handshake QR ↔ WebRTC ========= */
async function handleScannedObject(obj){
  if(obj.kind==="offer"){
    const ans=await acceptOffer(obj);
    drawQRPayload(JSON.stringify(ans)); // mostramos respuesta comprimida
    return;
  }
  if(obj.kind==="answer"){
    await acceptAnswer(obj);
    return;
  }
  alert("QR desconocido.");
}

/* ========= Botones ========= */
document.getElementById('offerBtn').addEventListener('click', async ()=>{
  busy(document.getElementById('offerBtn'), true);
  try{ const offer=await createOffer(); drawQRPayload(JSON.stringify(offer)); }
  catch(e){ alert("Error creando oferta: "+(e?.message||e)); }
  finally{ busy(document.getElementById('offerBtn'), false); }
});
document.getElementById('scanBtn').addEventListener('click', ()=> startScan());
document.getElementById('clearQRBtn').addEventListener('click', ()=>{
  const g=qrCanvas.getContext('2d'); g.clearRect(0,0,qrCanvas.width,qrCanvas.height);
});
document.getElementById('newConvBtn').addEventListener('click', ()=>{
  app.classList.remove('menu-open'); window.scrollTo({top:0,behavior:'smooth'});
});
document.getElementById('sendBtn').addEventListener('click', async ()=>{
  const inp=$("#msgInput"), text=inp.value.trim(); if(!text) return;
  if(!state.dc || state.dc.readyState!=="open") return alert("No hay canal abierto aún.");
  try{
    state.dc.send(text);
    const pid=state.currentPeer||"peer";
    await saveConversation(pid,text); await saveMessage(pid,"out",text); addBubble("out",text,Date.now()); inp.value=""; renderConversationList();
  }catch(e){ alert("Error enviando: "+(e?.message||e)); }
});

/* ========= Init ========= */
(async ()=>{
  await openDB();
  state.MY_ID = await computeDeviceId();
  document.getElementById('myIdChip').textContent = 'ID: '+state.MY_ID.slice(0,16);
  await renderConversationList();
  setStatus(false);
})();
})();</script>
</body>
</html>