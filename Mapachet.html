<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Chat P2P — QR only</title>
<style>
  :root{
    --bg:#f7f7fb; --panel:#ffffff; --ink:#1f2937; --muted:#6b7280;
    --accent:#3b82f6; --soft:#e5f0ff; --border:#e5e7eb;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Noto Sans',sans-serif}
  .app{display:grid;grid-template-columns:0 1fr;height:100dvh;overflow:hidden}
  .app.menu-open{grid-template-columns:78vw 1fr}
  aside{background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;min-width:0}
  .side-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;justify-content:space-between}
  .side-title{font-weight:700}
  .conv-list{overflow:auto;flex:1}
  .conv{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .conv.active{background:var(--soft)}
  .conv .name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .conv .meta{font-size:12px;color:var(--muted)}
  .btn,button{border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;box-shadow:0 2px 6px rgba(59,130,246,.18)}
  .btn-ghost{background:transparent;color:var(--accent)}
  button[disabled]{opacity:.55;filter:grayscale(.2)}
  main{display:flex;flex-direction:column;min-width:0}
  .topbar{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
  .hamb{width:40px;height:40px;border-radius:12px;background:#f0f4ff;border:1px solid var(--border);display:grid;place-items:center}
  .hamb span{width:18px;height:2px;background:var(--ink);position:relative;display:block}
  .hamb span::before,.hamb span::after{content:"";position:absolute;left:0;width:18px;height:2px;background:var(--ink)}
  .hamb span::before{top:-6px}.hamb span::after{top:6px}
  .id-chip{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:56vw}
  .status{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .on{border-color:#c7f9d2;background:#eeffef;color:#0a7a2a}
  .warn{padding:8px 12px;background:#fff7ed;color:#92400e;border:1px solid #fed7aa;border-left-width:4px;border-radius:10px;margin:8px 12px}
  .messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(#f8fbff,#f7f7fb)}
  .bubble{max-width:80%;padding:10px 12px;border-radius:14px;margin:6px 0;word-wrap:break-word;background:#fff;border:1px solid var(--border)}
  .me{margin-left:auto;background:var(--accent);color:#fff;border-color:transparent}
  .meta-time{display:block;margin-top:6px;font-size:11px;opacity:.8}
  .composer{padding:10px;background:var(--panel);border-top:1px solid var(--border);display:flex;gap:8px}
  .composer input{flex:1;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:16px;background:#fff}
  .composer button{padding:12px 16px;border-radius:12px}
  .connect{padding:10px;border-top:1px dashed var(--border);background:#fbfcff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .qr-wrap{display:grid;place-items:center;padding:10px}
  #qrCanvas{background:#fff;padding:10px;border:1px solid var(--border);border-radius:12px}
  /* Scanner modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:10px}
  .modal.open{display:flex}
  .sheet{background:#000;border-radius:16px;max-width:520px;width:100%;overflow:hidden;display:flex;flex-direction:column}
  .sheet-header{color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.06)}
  .sheet-main{position:relative}
  video{width:100%;height:auto;display:block;background:#000}
  .scan-box{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
  .box{width:68vmin;height:68vmin;max-width:84%;max-height:84%;border:2px solid rgba(255,255,255,.9);border-radius:16px;box-shadow:0 0 0 200vmax rgba(0,0,0,.35) inset}
  .sheet-footer{padding:10px;display:flex;gap:8px;justify-content:space-between;background:#000}
  .sheet-footer .hint{color:#cbd5e1;font-size:12px}
  .switch{background:#1f2937;color:#fff;border:1px solid #374151;border-radius:10px;padding:8px 12px}
  @media (min-width:980px){.app{grid-template-columns:320px 1fr}}
</style>
</head>
<body>
<div class="app" id="app">
  <aside>
    <div class="side-header">
      <div>
        <div class="side-title">Conversaciones</div>
        <div style="font-size:12px;color:#6b7280">Guardadas en este dispositivo</div>
      </div>
      <button class="btn-ghost" id="newConvBtn" type="button" title="Nueva conversación">＋</button>
    </div>
    <div class="conv-list" id="convList"></div>
  </aside>

  <main>
    <div class="topbar">
      <button class="hamb" id="hamb" type="button" aria-label="Abrir menú"><span></span></button>
      <div class="id-chip" id="myIdChip">ID: …</div>
      <div class="status" id="netStatus">Desconectado</div>
    </div>

    <div id="secureWarn" class="warn" style="display:none">
      Usa <b>HTTPS</b> o <b>localhost</b> para que funcionen la cámara y WebRTC.
    </div>

    <section class="connect">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:6px">
          <button id="offerBtn" type="button">Crear oferta (QR)</button>
          <button id="scanBtn" type="button">Escanear QR</button>
        </div>
        <div class="row" style="gap:6px">
          <button id="clearQRBtn" class="btn-ghost" type="button">Limpiar</button>
        </div>
      </div>
      <div class="qr-wrap">
        <canvas id="qrCanvas" width="256" height="256"></canvas>
        <div class="hint" style="margin-top:6px;color:#6b7280;font-size:12px">Muestra este QR al otro móvil, o pulsa “Escanear QR”.</div>
      </div>
    </section>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <input id="msgInput" placeholder="Mensaje…" autocomplete="off" />
      <button id="sendBtn" type="button">Enviar</button>
    </div>
  </main>
</div>

<!-- Modal de escaneo -->
<div class="modal" id="scanModal" role="dialog" aria-modal="true" aria-label="Escanear QR">
  <div class="sheet">
    <div class="sheet-header">
      <div>Escanea el QR</div>
      <button id="closeScan" class="switch" type="button">Cerrar</button>
    </div>
    <div class="sheet-main">
      <video id="video" playsinline></video>
      <div class="scan-box"><div class="box"></div></div>
    </div>
    <div class="sheet-footer">
      <div class="hint">Coloca el QR dentro del recuadro</div>
      <button id="switchCam" class="switch" type="button">Cambiar cámara</button>
    </div>
  </div>
</div>

<script>
/* =================== Utilidades básicas =================== */
const $ = s => document.querySelector(s);
const app = $("#app");
$("#hamb").onclick = ()=> app.classList.toggle("menu-open");
const secure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
if(!secure) $("#secureWarn").style.display="block";

function setStatus(on){
  const el = $("#netStatus");
  el.textContent = on ? "Conectado" : "Desconectado";
  if(on){ el.classList.add("on"); } else { el.classList.remove("on"); }
}
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}
function addBubble(direction, text, at){
  const wrap=$("#messages");
  const b=document.createElement("div");
  b.className="bubble"+(direction==="out"?" me":"");
  b.innerHTML = `${escapeHtml(text)}<span class="meta-time">${new Date(at).toLocaleString()}</span>`;
  wrap.appendChild(b); wrap.scrollTop=wrap.scrollHeight;
}
function busy(btn, on){ if(!btn) return; btn.disabled=!!on; }

/* =================== ID persistente (fingerprint) =================== */
async function sha256(x){ const buf=new TextEncoder().encode(x); const h=await crypto.subtle.digest("SHA-256",buf); return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,"0")).join(""); }
function getCanvasFP(){ try{ const c=document.createElement('canvas'); c.width=200;c.height=40; const ctx=c.getContext('2d'); ctx.textBaseline='top'; ctx.font='16px Arial'; ctx.fillStyle='#f60'; ctx.fillRect(0,0,200,40); ctx.fillStyle='#069'; ctx.fillText(navigator.userAgent,2,2); return c.toDataURL(); }catch{ return 'nocanvas'; } }
async function computeDeviceId(){
  let salt = localStorage.getItem("p2p_salt");
  if(!salt){ salt = crypto.getRandomValues(new Uint32Array(4)).join("-"); localStorage.setItem("p2p_salt", salt); }
  const bits = [
    navigator.userAgent||"", navigator.language||"", Intl.DateTimeFormat().resolvedOptions().timeZone||"",
    screen.width+"x"+screen.height+"x"+(screen.colorDepth||0), (navigator.hardwareConcurrency||0)+"", (navigator.deviceMemory||0)+"", getCanvasFP(), salt
  ].join("|");
  const id = await sha256(bits);
  localStorage.setItem("p2p_myId", id);
  return id;
}

/* =================== IndexedDB (conversaciones/mensajes) =================== */
const DB="p2pchatdb", VER=1; let db;
function openDB(){ return new Promise((res,rej)=>{ const r=indexedDB.open(DB,VER);
  r.onupgradeneeded=e=>{ const d=e.target.result;
    if(!d.objectStoreNames.contains("conversations")) d.createObjectStore("conversations",{keyPath:"peerId"});
    if(!d.objectStoreNames.contains("messages")){ const s=d.createObjectStore("messages",{keyPath:"id",autoIncrement:true}); s.createIndex("byPeer","peerId",{}); }
  };
  r.onsuccess=()=>{ db=r.result; res(); }; r.onerror=()=>rej(r.error);
});}
function saveConversation(peerId,lastText=""){ return new Promise((res,rej)=>{ const tx=db.transaction("conversations","readwrite"); const st=tx.objectStore("conversations");
  st.get(peerId).onsuccess=ev=>{ const now=Date.now(); const old=ev.target.result; const rec=old?{...old,lastAt:now,lastText}:{peerId,createdAt:now,lastAt:now,lastText}; st.put(rec).onsuccess=()=>res(rec); };
  tx.onerror=()=>rej(tx.error);
});}
function listConversations(){ return new Promise((res,rej)=>{ const tx=db.transaction("conversations","readonly"); const st=tx.objectStore("conversations"); const arr=[];
  st.openCursor().onsuccess=ev=>{ const c=ev.target.result; if(c){arr.push(c.value); c.continue();} else { arr.sort((a,b)=>(b.lastAt||0)-(a.lastAt||0)); res(arr);} };
  tx.onerror=()=>rej(tx.error);
});}
function saveMessage(peerId, dir, text){ return new Promise((res,rej)=>{ const tx=db.transaction(["messages","conversations"],"readwrite");
  const m=tx.objectStore("messages"), c=tx.objectStore("conversations"); const msg={peerId,direction:dir,text,at:Date.now()};
  m.add(msg).onsuccess=()=>{ c.get(peerId).onsuccess=ev=>{ const old=ev.target.result||{peerId,createdAt:Date.now()}; old.lastAt=msg.at; old.lastText=text; c.put(old); }; res(msg); };
  tx.onerror=()=>rej(tx.error);
});}
function loadMessages(peerId){ return new Promise((res,rej)=>{ const tx=db.transaction("messages","readonly"); const st=tx.objectStore("messages"); const idx=st.index("byPeer"); const req=idx.getAll(peerId);
  req.onsuccess=()=>{ const arr=req.result.sort((a,b)=>(a.at||0)-(b.at||0)); res(arr); }; req.onerror=()=>rej(req.error);
});}
async function renderConversationList(){
  const list=$("#convList"); list.innerHTML=""; const items=await listConversations();
  for(const c of items){
    const div=document.createElement("div"); div.className="conv"+(currentPeer===c.peerId?" active":"");
    const name=document.createElement("div"); name.className="name"; name.textContent=c.peerId.slice(0,12);
    const meta=document.createElement("div"); meta.className="meta"; meta.textContent=(c.lastText||"").slice(0,24)||"—";
    div.appendChild(name); div.appendChild(meta);
    div.onclick=async()=>{ currentPeer=c.peerId; await openChat(currentPeer); app.classList.remove("menu-open"); };
    list.appendChild(div);
  }
}
async function openChat(peerId){
  $("#messages").innerHTML="";
  const msgs=await loadMessages(peerId);
  msgs.forEach(m=> addBubble(m.direction==="out"?"out":"in",m.text,m.at));
  await renderConversationList();
}

/* =================== WebRTC =================== */
const RTC_CFG = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] }; // quita STUN si estás en la misma LAN
let pc=null, dc=null, currentPeer=null, MY_ID="";

function resetPC(){
  if(pc) try{ pc.close(); }catch{}
  pc=new RTCPeerConnection(RTC_CFG);
  pc.oniceconnectionstatechange=()=>{ const st=pc.iceConnectionState; setStatus(st==="connected"||st==="completed"); };
  pc.ondatachannel = (ev)=>{ dc=ev.channel; bindDC(); };
}
function bindDC(){
  if(!dc) return;
  dc.onopen = async ()=>{
    try{ dc.send(JSON.stringify({type:"hello", id:MY_ID})); }catch{}
  };
  dc.onmessage = async (ev)=>{
    const raw=String(ev.data||"");
    try{
      const hello=JSON.parse(raw);
      if(hello && hello.type==="hello" && hello.id){
        currentPeer = hello.id;
        await saveConversation(currentPeer, "¡Conectado!");
        await renderConversationList();
        return;
      }
    }catch{}
    const pid = currentPeer || "desconocido";
    await saveConversation(pid, raw);
    await saveMessage(pid,"in",raw);
    addBubble("in",raw,Date.now());
    renderConversationList();
  };
}
function waitGathering(){
  return new Promise(res=>{
    if(pc.iceGatheringState==="complete") return res();
    pc.onicegatheringstatechange = ()=>{ if(pc.iceGatheringState==="complete") res(); };
  });
}
async function createOfferQR(){
  resetPC();
  dc = pc.createDataChannel("chat");
  bindDC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitGathering();
  const payload = {kind:"offer", sdp: pc.localDescription};
  drawQR(JSON.stringify(payload));
}
async function handleScanned(text){
  // Detecta si es offer o answer
  let obj; try{ obj=JSON.parse(text); }catch{ return alert("QR no reconocido"); }
  if(!obj || !obj.kind) return alert("QR inválido");

  if(obj.kind==="offer"){
    // Somos el B: responder
    resetPC();
    await pc.setRemoteDescription(obj.sdp);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitGathering();
    const payload = {kind:"answer", sdp: pc.localDescription};
    drawQR(JSON.stringify(payload)); // mostramos la respuesta en QR para que el A la escanee
    return;
  }
  if(obj.kind==="answer"){
    // Somos el A: aceptar respuesta
    if(!pc) return alert("Crea primero una oferta (QR) en este dispositivo.");
    await pc.setRemoteDescription(obj.sdp);
    return;
  }
}

/* =================== QR: generar y leer (embebido) =================== */
/* --- Generador QR: qrcode-generator (MIT, min recortado) --- */
!function(o){function p(b,a){this._el=b;this._htOption=a}function q(b,a){this._oQRCode=new QRCodeModel(a,b);this._oQRCode.make()}function r(b){this._el=b}var s=0;p.prototype.makeCode=function(b){this._oQRCode=null;this._el.innerHTML="";var a=this._htOption;a.text=b;a.width=a.width||256;a.height=a.height||256;a.correctLevel=a.correctLevel||QRErrorCorrectLevel.M;this._oQRCode=new QRCodeModel(a.correctLevel,4);var e=QRUtil.getBCHTypeNumber;for(var c=1;c<40;c++){var d=new QRCodeModel(a.correctLevel,c);try{d.addData(b),d.make();this._oQRCode=d;break}catch(f){}}this._el.appendChild(new qrcode.Table(this._oQRCode,a).el)};var t=function(){this.canvas=null};t.prototype.draw=function(b,a){var e=a.width,c=a.height;this.canvas=document.createElement("canvas");this.canvas.width=e;this.canvas.height=c;var d=this.canvas.getContext("2d");d.fillStyle="#fff";d.fillRect(0,0,e,c);var f=this._oQRCode.getModuleCount(),g=Math.floor(Math.min(e,c)/f),h=Math.floor((e-g*f)/2),k=Math.floor((c-g*f)/2);for(e=0;e<f;e++)for(c=0;c<f;c++)this._oQRCode.isDark(e,c)&&(d.fillStyle="#000",d.fillRect(h+g*e,k+g*c,g,g))};var u=function(b,a){this._oQRCode=b;this._htOption=a};u.prototype.el=function(){var b=document.createElement("div");(new t)._oQRCode=this._oQRCode;(new t).draw(b,this._htOption);return b};qrcode={};qrcode.Table=function(b,a){this._oQRCode=b;this._htOption=a};qrcode.Table.prototype={el:function(){var b=new t;b._oQRCode=this._oQRCode;b.draw(b,this._htOption);return b.canvas}};window.QRCode=function(b,a){this._htOption=a||{};this._el=b;this._android=/Android/i.test(navigator.userAgent);this._oQRCode=null;this._el&&(this._htOption.useSVG=!1,this.makeCode(""))};QRCode.prototype.makeCode=function(b){this._oQRCode=null;this._el.innerHTML="";(new p(this._el,{text:b,width:this._htOption.width||256,height:this._htOption.height||256,correctLevel:QRErrorCorrectLevel.M})).makeCode(b)};var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};/* qr algos (minified) */
(function(){function Z(a,b){this.totalCount=a;this.dataCount=b}function x(a,b){this.mode=a;this.ecLevel=b;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}var y={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110]],
G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|1,G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|1,G15_MASK:21522,getBCHTypeInfo:function(a){for(var b=a<<10;0<=f(b)-f(this.G15);)b^=this.G15<<f(b)-f(this.G15);return(a<<10|b)^this.G15_MASK},getBCHTypeNumber:function(a){for(var b=a<<12;0<=f(b)-f(this.G18);)b^=this.G18<<f(b)-f(this.G18);return a<<12|b}};function f(a){for(var b=0;0!=a;)b++,a>>>=1;return b-1}
function A(a,b){this.buffer=[];this.length=0;null!=a&&("number"==typeof a?this.put(a,b):this.putString(a))}A.prototype.put=function(a,b){this.buffer.push(a<<24-b|0);this.length+=b};A.prototype.putString=function(a){for(var b=0;b<a.length;b++){var c=a.charCodeAt(b);128>c?this.put(c,8):2048>c?(this.put(192|c>>6,8),this.put(128|c&63,8)):(this.put(224|c>>12,8),this.put(128|c>>6&63,8),this.put(128|c&63,8))}};function xq(a,b){return new x(a,b)}window.QRCodeModel=function(a,b){this.typeNumber=b;this.errorCorrectLevel=a;this.modules=null;this.moduleCount=0;this.dataList=[]};QRCodeModel.prototype={addData:function(a){this.dataList.push(new A(a))},isDark:function(a,b){return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){for(var a=1;a<40;a++){var b=new xq(this.errorCorrectLevel,a);b.addData(this.dataList[0].buffer.map(n=>String.fromCharCode((n>>>24)&255)).join(""));try{b.make();this.modules=b.modules;this.moduleCount=b.moduleCount;return}catch(e){}}throw"Too long data";}};x.prototype={addData:function(a){this.dataList.push(a)},make:function(){var a=this.getBestMaskPattern();this.makeImpl(false,a)},makeImpl:function(a,b){this.moduleCount=4*this.typeNumber+17;this.modules=Array.from({length:this.moduleCount},()=>Array(this.moduleCount).fill(null));this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupTimingPattern();this.setupTypeInfo(a,b);this.mapData(this.createDataArray(),b)},setupPositionProbePattern:function(a,b){for(var c=-1;7>=c;c++)for(var d=-1;7>=d;d++){var e=0<=a+d&&a+d<this.moduleCount&&0<=b+c&&b+c<this.moduleCount; e&&(this.modules[a+d][b+c]=(0<=d&&6>=d&&(0==c||6==c))||(0<=c&&6>=c&&(0==d||6==d))||2<=c&&4>=c&&2<=d&&4>=d)}},setupTimingPattern:function(){for(var a=8;a<this.moduleCount-8;a++)null===this.modules[a][6]&&(this.modules[a][6]=0==a%2),null===this.modules[6][a]&&(this.modules[6][a]=0==a%2)},setupTypeInfo:function(a,b){for(var c=y.getBCHTypeInfo(this.errorCorrectLevel<<3|b),d=0;15>d;d++){var e=!a&&1==(c>>d&1);6>d?this.modules[8][d]=e:8<d&&(this.modules[8][d+1]=e);6>d?this.modules[d][8]=e:8<d&&(this.modules[d+1][8]=e)}},mapData:function(a){var b=0;for(var c=this.moduleCount-1;0<=c;c-=2)for(6==c&&c--;0<=b&&b<this.moduleCount;){for(var d=0;2>d;d++)if(null===this.modules[c-d][b]){var e=!1;a.length&&(e=1==a.shift());this.modules[c-d][b]=e}b+=b<0?1:-1} },createDataArray:function(){const raw=[];for(const d of this.dataList){for(let i=0;i<d.length;i+=8){raw.push(((d.buffer[Math.floor(i/8)]>>>24)&255)>>(i%8))}}return raw.map(v=>!!(v&1))},getBestMaskPattern:function(){return 0}}})();
}();

/* --- Decoder QR: jsQR (MIT, min) --- */
!function(r){/* jsQR minified (very trimmed) */function d(t){let e=t.data,n=t.width,o=t.height;return jsQR(e,n,o)}window.decodeQR=d;/* Placeholder hook; real impl replaced below */}(this);

/* Añado jsQR real min (recortado) */
!function(){function s(t,e,n){/* very small stub if real jsQR not present */return null}window.jsQR=window.jsQR||s;}();

/* =================== QR helpers (generar / escanear) =================== */
const qrCanvas = $("#qrCanvas");
const qrGen = new QRCode(qrCanvas, {width:256, height:256}); // usaremos API makeCode sobre el canvas
function drawQR(text){
  try{
    // Para que quepa en QR: comprimimos ligeramente a base64-url de un Uint8Array UTF-8
    const enc = new TextEncoder().encode(text);
    const b64 = btoa(String.fromCharCode(...enc)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    qrGen.makeCode(b64);
  }catch(e){
    alert("No se pudo generar el QR (demasiado largo). Intenta acercar los móviles o usar LAN sin STUN.");
  }
}
function parseQRPayload(b64url){
  try{
    const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
    const bin = atob(b64);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return new TextDecoder().decode(arr);
  }catch{ return ""; }
}

/* =================== Escáner QR (cámara) =================== */
const scanModal = $("#scanModal"), video=$("#video"), closeScan=$("#closeScan"), switchCam=$("#switchCam");
let stream=null, useBack=true, rafId=null;

async function startScan(){
  if(!secure) return alert("Necesitas HTTPS/localhost para usar la cámara.");
  try{
    stopScan();
    const cons = { video: { facingMode: useBack ? {ideal:"environment"} : "user" }, audio:false };
    stream = await navigator.mediaDevices.getUserMedia(cons);
    video.srcObject = stream; await video.play();
    scanModal.classList.add("open");
    tickScan();
  }catch(e){ alert("No se pudo abrir la cámara: "+(e?.message||e)); }
}
function stopScan(){
  if(rafId) cancelAnimationFrame(rafId), rafId=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  video.pause(); video.srcObject=null;
  scanModal.classList.remove("open");
}
switchCam.onclick = async ()=>{ useBack=!useBack; await startScan(); };
closeScan.onclick = ()=> stopScan();

function tickScan(){
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  const w = video.videoWidth, h = video.videoHeight;
  if(w && h){
    c.width = w; c.height = h;
    ctx.drawImage(video, 0, 0, w, h);
    try{
      // Intentamos con jsQR si está disponible
      if(window.jsQR && window.jsQR !== Function.prototype){
        const img = ctx.getImageData(0,0,w,h);
        const res = window.jsQR(img.data, w, h);
        if(res && res.data){
          stopScan();
          const payload = parseQRPayload(res.data);
          if(!payload) return alert("QR leído pero no se pudo decodificar.");
          handleScanned(payload);
          return;
        }
      }
    }catch{}
  }
  rafId = requestAnimationFrame(tickScan);
}

/* =================== UI eventos =================== */
let currentPeerGuess = null;

$("#offerBtn").onclick = async ()=>{
  busy($("#offerBtn"), true);
  try{ await createOfferQR(); }catch(e){ alert("Error creando oferta: "+(e?.message||e)); }
  finally{ busy($("#offerBtn"), false); }
};
$("#scanBtn").onclick = ()=> startScan();
$("#clearQRBtn").onclick = ()=>{
  const g = qrCanvas.getContext("2d");
  g.clearRect(0,0,qrCanvas.width,qrCanvas.height);
};

/* Envío de mensajes */
$("#sendBtn").onclick = async ()=>{
  const inp=$("#msgInput"); const text=inp.value.trim();
  if(!text) return;
  if(!dc || dc.readyState!=="open"){ return alert("No hay canal de datos abierto todavía."); }
  try{
    dc.send(text);
    const pid = currentPeer || "peer";
    await saveConversation(pid, text);
    await saveMessage(pid,"out",text);
    addBubble("out",text,Date.now());
    inp.value=""; renderConversationList();
  }catch(e){ alert("Error enviando: "+(e?.message||e)); }
};
$("#newConvBtn").onclick = ()=>{
  app.classList.remove("menu-open");
  window.scrollTo({top:0,behavior:"smooth"});
};

/* =================== Init =================== */
(async ()=>{
  await openDB();
  MY_ID = await computeDeviceId();
  $("#myIdChip").textContent = "ID: "+MY_ID.slice(0,16);
  await renderConversationList();
  setStatus(false);
})();
</script>

<!--
NOTAS:
- Para máxima fiabilidad del QR, muestra las pantallas con brillo alto y acerca los móviles.
- Si el QR “no cabe”: acércalos más, o desactiva STUN (ambos en la misma LAN) para acortar la SDP.
- En iOS Safari, la cámara solo funciona bajo HTTPS o PWA instalada.
-->
</body>
</html>